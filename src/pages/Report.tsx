import { useEffect, useState } from 'react'
import { useNavigate, useSearchParams } from 'react-router-dom'
import { useTranslation } from 'react-i18next'
import { useDreamStore } from '../store/dreamStore'
import { getTelegramUserId } from '../lib/telegram'
import LanguageSelector from '../components/LanguageSelector'

export default function Report() {
  const { t } = useTranslation()
  const navigate = useNavigate()
  const [searchParams] = useSearchParams()
  const { dreamResult } = useDreamStore()
  const [report, setReport] = useState<string>('')
  
  const isPreviewMode = searchParams.get('preview') === '1'
  const hasPreviewInUrl = typeof window !== 'undefined' && window.location.search.includes('preview=1')
  const isBrowser = typeof window !== 'undefined' && !getTelegramUserId()
  const showPreview = isPreviewMode || hasPreviewInUrl || isBrowser

  // ë¯¸ë¦¬ë³´ê¸° ëª¨ë“œì—ì„œ dreamResultê°€ ì—†ìœ¼ë©´ mock ë°ì´í„° ì‚¬ìš©
  const previewMockResult = showPreview && !dreamResult ? {
    essence: "ë‹¹ì‹ ì˜ ê¿ˆì€ í‘œí˜„ì„ ê°ˆêµ¬í•˜ëŠ” ìˆ¨ê²¨ì§„ ê°ì •ì„ ë“œëŸ¬ëƒ…ë‹ˆë‹¤.",
    hiddenMeaning: "ë‹¹ì‹ ì˜ ë¬´ì˜ì‹ì´ ìˆ¨ê¸°ê³  ìˆëŠ” ê±°ëŒ€í•œ ì‹ í˜¸ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ê¿ˆì€ ë‹¨ìˆœí•œ ê¸°ì–µì´ ì•„ë‹ˆë¼ ë‹¹ì‹ ì˜ ìš´ëª…ì„ ë°”ê¿€ ë°”ë‹¤ì˜ ë³€í˜ì  í˜ì„ í’ˆê³  ìˆìŠµë‹ˆë‹¤.",
    symbols: [
      { emoji: "ğŸŒŠ", name: "ë°”ë‹¤", meaning: "ê¹Šì€ ê°ì •ê³¼ ë¬´ì˜ì‹" },
      { emoji: "ğŸ¦‹", name: "ë‚˜ë¹„", meaning: "ë³€í™”ì™€ ë³€í˜•" },
      { emoji: "ğŸŒ™", name: "ë‹¬", meaning: "ì§ê´€ê³¼ ì—¬ì„±ì  ì—ë„ˆì§€" }
    ],
    deepInsight: "ë‹¹ì‹ ì˜ ê¿ˆì€ ë¬´ì˜ì‹ì˜ ì„¸ê³„ë¡œ ì—´ë¦¬ëŠ” ì°½ì…ë‹ˆë‹¤. ê¿ˆì† ìƒì§•ë“¤ì€ ì¸ì •ì„ ê°ˆêµ¬í•˜ëŠ” ë‚´ë©´ì˜ ì¸¡ë©´ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤. ë°”ë‹¤ëŠ” ê°ì •ì˜ ê¹Šì´ë¥¼, ë‚˜ë¹„ëŠ” ë³€í˜•ì˜ ì‹œê¸°ë¥¼, ë‹¬ì€ ì§ê´€ì´ ì´ ë³€í™”ë¥¼ ì´ëŒê³  ìˆìŒì„ ë§í•´ì¤ë‹ˆë‹¤.",
    psychologicalShadow: "ìœµì˜ ê´€ì ì—ì„œ, ê¿ˆì† ë°”ë‹¤ëŠ” ì–µì••ëœ ê°ì •ê³¼ ì›í˜•ì´ ë¨¸ë¬´ëŠ” ë¬´ì˜ì‹ì˜ ì˜ì—­ì„ ìƒì§•í•©ë‹ˆë‹¤.",
    easternProphecy: "ë™ì–‘ í•´ëª½ì—ì„œ ë¬¼(æµ·)ì€ ì§€í˜œì™€ ê°ì •ì˜ íë¦„ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.",
    spiritualAdvice: "ë¬¼ê°€ì—ì„œ ëª…ìƒí•˜ê±°ë‚˜ ê³ ìš”í•œ ë°”ë‹¤ë¥¼ ìƒìƒí•´ ë³´ì„¸ìš”. 30ì¼ê°„ ê¿ˆ ì¼ê¸°ë¥¼ ì¨ ë³´ì„¸ìš”.",
    advice: ["ì˜¤ëŠ˜ í•˜ë£¨ ìê¸° ì„±ì°° ì‹œê°„ì„ ê°€ì§€ì„¸ìš”", "ê²°ì •í•  ë•Œ ì§ê´€ì„ ë¯¿ìœ¼ì„¸ìš”", "ì°½ì‘ í™œë™ìœ¼ë¡œ ê°ì •ì„ í‘œí˜„í•´ ë³´ì„¸ìš”"],
    emotionalTone: "ëª…ìƒì ",
    spiritualMessage: "ì˜í˜¼ì´ ì´ ìƒì§•ë“¤ì„ í†µí•´ ë§í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì „í•´ì§€ëŠ” ë©”ì‹œì§€ë¥¼ ë¯¿ê³  ì„±ì¥ì„ ë°›ì•„ë“¤ì´ì„¸ìš”."
  } : null

  const displayResult = dreamResult || previewMockResult

  useEffect(() => {
    if (!displayResult && !showPreview) {
      navigate('/result')
      return
    }

    // Generate comprehensive report
    const generateReport = () => {
      if (!displayResult) return
      const reportSections = [
        `# Soul Message Report\n\n`,
        `## Dream Essence\n${displayResult.essence}\n\n`,
        `## Detailed Analysis\n${displayResult.deepInsight}\n\n`,
        `## Key Symbols\n${displayResult.symbols.map(s => `- ${s.emoji} **${s.name}**: ${s.meaning}`).join('\n')}\n\n`,
        `## Actionable Guidance\n${displayResult.advice.map((a, i) => `${i + 1}. ${a}`).join('\n')}\n\n`,
        `## Spiritual Message\n${displayResult.spiritualMessage}\n\n`,
        `## 7-Day Guidance\n\n`,
        `### Day 1-2: Reflection\nTake time to reflect on the symbols and messages from your dream. Journal about any emotions or memories it triggered.\n\n`,
        `### Day 3-4: Integration\nBegin to integrate the insights into your daily life. Pay attention to synchronicities and signs.\n\n`,
        `### Day 5-7: Action\nTake concrete steps based on the advice provided. Trust your intuition and the guidance you've received.\n\n`,
        `---\n*Generated by ONEIRO â€” AI Dream Interpreter & Soul Guide*`,
      ]

      setReport(reportSections.join(''))
    }

    generateReport()
  }, [displayResult, navigate, showPreview])

  const handleDownload = () => {
    const blob = new Blob([report], { type: 'text/markdown' })
    const url = URL.createObjectURL(blob)
    const link = document.createElement('a')
    link.href = url
    link.download = `soul-report-${new Date().toISOString().split('T')[0]}.md`
    link.click()
    URL.revokeObjectURL(url)
  }

  const handleShare = () => {
    try {
      if (window.Telegram?.WebApp?.openLink) {
        const shareText = `My Soul Message Report from ONEIRO ğŸŒ™\n\n${displayResult?.essence || 'Preview mode'}`
        window.Telegram.WebApp.openLink(
          `https://t.me/share/url?url=${encodeURIComponent(shareText)}`
        )
      }
    } catch {
      // WebApp ë©”ì„œë“œ ë¯¸ì§€ì› ì‹œ ë¬´ì‹œ (ë¸Œë¼ìš°ì € ë“±)
    }
  }

  if (!displayResult) return null

  return (
    <div className="min-h-screen bg-gradient-midnight p-6">
      <div className="max-w-2xl mx-auto">
        {/* Language Selector */}
        <div className="flex justify-end mb-4">
          <LanguageSelector />
        </div>
        <div className="card mb-6">
          <h1 className="text-2xl font-title font-bold text-white mb-4">
            ğŸ“œ Soul Message Report
          </h1>
          <div className="prose prose-invert max-w-none">
            <pre className="whitespace-pre-wrap text-text-primary font-mono text-sm bg-secondary p-6 rounded-lg overflow-auto max-h-[600px]">
              {report}
            </pre>
          </div>
        </div>

        <div className="flex gap-4">
          <button onClick={handleDownload} className="btn-primary flex-1">
            Download Report
          </button>
          <button onClick={handleShare} className="btn-primary flex-1">
            {t('result.share')}
          </button>
        </div>

        <button
          onClick={() => navigate('/dream')}
          className="btn-primary w-full mt-4"
        >
          {t('visualize.another')}
        </button>
      </div>
    </div>
  )
}
